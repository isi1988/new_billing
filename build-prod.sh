#!/bin/bash

# –í—ã—Ö–æ–¥–∏–º –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞, –µ—Å–ª–∏ –ª—é–±–∞—è –∫–æ–º–∞–Ω–¥–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π
set -e

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
# –ò–º—è –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
DEFAULT_APP_NAME="new-billing"
# –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ —Å–∫—Ä–∏–ø—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
APP_NAME=${1:-$DEFAULT_APP_NAME}
# --------------------

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –û–° –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–∞
GOOS=$(go env GOOS)
if [ "$GOOS" = "windows" ]; then
    APP_NAME="${APP_NAME}.exe"
fi

echo "üöÄ Starting production build..."
echo "Output file will be: $APP_NAME"
echo ""

# --- –®–ê–ì 1: –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ ---
echo "üì¶ [1/2] Building Vue.js frontend..."
# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
cd frontend

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "  -> Running 'npm install'..."
npm install > /dev/null 2>&1 # –°–∫—Ä—ã–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π –≤—ã–≤–æ–¥ npm

# –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫—É /dist
echo "  -> Running 'npm run build'..."
npm run build
echo "‚úÖ Frontend build complete."
echo ""

# –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞
cd ..

# --- –®–ê–ì 2: –°–±–æ—Ä–∫–∞ –±—ç–∫–µ–Ω–¥–∞ ---
echo "üõ†Ô∏è  [2/2] Building Go backend and embedding frontend..."
# –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–ª–∞–≥–∏ -ldflags "-s -w" –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
# -s: —É–±—Ä–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å–∏–º–≤–æ–ª–æ–≤
# -w: —É–±—Ä–∞—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
go build -ldflags="-s -w" -o "$APP_NAME" ./cmd/main.go
echo "‚úÖ Go backend build complete."
echo ""

# --- –ó–ê–í–ï–†–®–ï–ù–ò–ï ---
echo "‚ú® Build finished successfully!"
echo "Run your application with: ./$APP_NAME"